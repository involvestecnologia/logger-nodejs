steps:
  - label: "Tests"
    key: "test"
    command:
      - npm install --no-audit
      - npm test
    agents:
      queue: "node14"

  - label: "Publish Library"
    key: "publish"
    command:
      - "git config --global url.ssh://git@github.com/.insteadOf https://github.com/"
      - "ssh-keygen -F github.com || ssh-keyscan github.com >>~/.ssh/known_hosts"
      - "npm version patch"
      - "git push origin HEAD:master --force --signed"
      - "git push origin HEAD:master --force --signed --tags"
    agents:
      queue: "node14"
    depends_on:
      - "test"
    if: build.branch == "master"